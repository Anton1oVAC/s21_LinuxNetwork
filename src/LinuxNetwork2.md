## Part 1. Инструмент ipcalc


#### 1.1 Сети и маски

1. Адрес сети для 192.167.38.54/13 = **192.160.0.0/13**
![](./Screen/1.1.1%20-%20ipcalc%20192.168.38.54:13.png)

2. 
Перевод маски 255.255.255.0 в префиксную и двоичную систему = **Префикс: /24**; Двоичная система: **11111111.11111111.11111111.00000000**
![](./Screen/1.1.2.1%20-%20255.255.255.0.png)
/15 в обычную = **255.254.0.0**; /15 в двоичную = **11111111.11111111.00000000.00000000**
![](./Screen/1.1.2.2%20-%20:15%20prefix.png)
11111111.11111111.11111111.11110000 = В обычную систему: **255.255.255.240**; Префикс **/28**
![](./Screen/1.1.2.3%20-%20:28%20prefix.png)

3. 
Hostmin и hostmax сети 12.167.38.4 при масках - 
/8: min- **12.0.0.1**; max- **12.255.255.254**
![](./Screen/1.1.3.1%20-%20min:max%20host:8%20.png)
11111111.11111111.00000000.00000000: min- **12.167.0.1**; max- **12.167.255.254**
![](./Screen/1.1.3.2%20-%20min:max%20host:16.png)
255.255.254.0: min- **12.167.38.1**; max- **12.167.39.254**
![](./Screen/1.1.3.3%20-%20min:max%20host:23.png)
/4: min- **0.0.0.1**; max- **15.255.255.254**
![](./Screen/1.1.3.4%20-%20min:max%20host:4.png)


#### 1.2 Localhost
Можно ли обратиться к приложению, работающему на localhost, со следующими IP?

1. 127.0.0.2 - **Можно** 
2. 127.1.0.1 - **Можно** 
3. 194.34.23.100 - **Нельзя**
4. 128.0.0.1 - **Нельзя**


#### 1.3 Диапазоны и сегменты сетей

1. В качестве частных можно использовать:  
		**10.0.0.45  
		192.168.4.2  
		172.20.250.4  
		172.0.2.1  
		172.16.255.255  
		10.10.10.10**

	В качестве публичных можно использовать:  
		**134.43.0.2  
		192.172.0.1  
		172.68.0.2  
		192.169.168.1**  
		  
     
2. Возможно:  
		**10.10.0.2  
		10.10.10.10  
		10.10.1.255**  
	Невозможно:  
		**10.0.0.1  
		10.10.100.1**  



## Part 2. Статическая маршрутизация между двумя машинами

С помощью команды ip a смотрю существующие сетевые интерфесы:

- Первая машина:
![](./Screen/2-%20ip%20a1.png)
- Вторая машина:
![](./Screen/2-%20ip%20a2.png)

Изменяю адрес и маску сети. 

- С помощью команды: sudo nano etc/netplan/00-installer-config.yaml открываю файл в редакторе nano и добавляю строчку addresses
![](./Screen/2-%20ws1%20192....png)
![](./Screen/2-%20ws2%20172....png)
- После перезагружаю сервис сети командой: sudo netplan apply 
![](./Screen/2-%20ws1%20netplan%20apply.png)
![](./Screen/2-%20ws2%20netplan%20apply.png)

#### 2.1 Добавление статического маршрута вручную

- С помощью команды ip r add присваиваю статический маршрут:
![](./Screen/2.1-%20ws1%20assign%20172....png)
![](./Screen/2.1-%20ws2%20assign%20192....png)

- После пропинговываю соединения между машинами:
![](./Screen/2.1-%20ws1%20ping.png)
![](./Screen/2.1-%20ws2%20ping.png)   

#### 2.2 Добавление статического маршрута с сохранинем
- Перезагружаю машины с комощью команды: init 6 и проверю, чтобы после перезагрузки сбросились статические маршруты 
![](./Screen/2.2-%20ws1%20init%206.png)
![](./Screen/2.2-%20ws2%20init%206.png)

- Открываю файл etc/netplan/00-installer-config.yaml и добавляю строчку routes, чтобы задать статический маршрут от одной машины до другой 
![](./Screen/2.2-%20ws1%20-%20nano%20static%20ip%20.png)
![](./Screen/2.2-%20ws2%20-%20nano%20static%20ip.png)

- После перезагружаю сеть: sudo netplan apply и пропинговываю  
![](./Screen/2.2-%20ws1%20ping%20static%20ip.png)
![](./Screen/2.2-%20ws2%20-%20ping%20static%20ip.png)

## Part 3. Утилита iperf3

#### 3.1 Скорость соединения 
- 8 Mbps = 1 MB/s (8 Мегабит в секунду = 1 Мегабайт в секунду)
- 100 MB/s = 800000 Kbps (100 Мегабит в секунду = 800000 Килобит в секунду)
- 1 Gbps = 1000 Mbps (1 Гигабит в секунду = 1000 Мегабит)

#### 3.2 Утилита iperf3
Чтобы протестировать пропускную способность между машинами, нужно сделать:

- Первая машина (ws1) выступает в роли сервера: запускаю серверную часть с команды -iperf3 -s, а вторая машина (ws2) выступает в роли клиента: для запуска тестирования пишу команду -iperf3 -c 192.168.100.10
![](./Screen/3.2-%20ws1%20iperf3%20-s.png)
![](./Screen/3.2-%20ws2%20iperf3%20-c%20192.png)


## Part 4. Сетевой экран 

#### 4.1 Утилита iptables
- Создаю файл /etc/firewall.sh для ws1 и ws2 и прописываю в него правила.
![](./Screen/4.1-%20ws1%20iptables.png)
![](./Screen/4.1-%20ws2%20iptables.png)

- Запускаю файл:
![](./Screen/4.1-%20ws1%20firewall.sh.png)
![](./Screen/4.1-%20ws2%20firewall.sh.png)

Описать разницу стратегий:

- Важно отменить, что последние команды имею противоречивые правила для одного и того же типа пакетов. Первая команда в (ws1) блокирует эти пакеты, а вторая команда разрешает. Правила обрабатываются по порядку их объявления, поэтому у (ws1) не будет запроса на пинг. А в (ws2) первая команда разрешает запросы на пинг. 

#### 4.2 Утилита nmap
- Поскольку c помощью файла (firewall.sh) в первой машине заблокирована передача пакетов, то
проверяю пинг с: 172.24.116.8 
И с помощью утилиты nmap показываю, что хост запущен
![](./Screen/4.2-%20ws1%20nmap%20ping.png)



## Part 5. Статическая маршрутизация сети

#### 5.1. Настройка адресов машин
- В настройках ВБ поменял адаптер на «Внутренюю сеть»
- Каждой созданной ВМ прописал конфигурацию. После настройки конфигурации применяю изменение командой: -sudo netplan apply
![](./Screen/5.1-%20ws11%20addr.png)
![](./Screen/5%2C1-%20ws21%20addr.png)
![](./Screen/5.1-%20ws22%20addr.png)
![](./Screen/5.1-%20r1%20addr.png)
![](./Screen/5.1-%20r2%20addr.png)


- Ошибки не обнаружены. Далее прописываю каждой ВМ команду: 	-ip - 4 a, проверяя, что адрес машин задан верно.
![](./Screen/5.1-%20ws11%20ip%20-4%20a.png)
![](./Screen/5.1-%20ws21%20ip%20-4%20a.png)
![](./Screen/5.1-%20ws22%20ip%20-4%20a.png)
![](./Screen/5.1-%20r1%20ip%20-4%20a.png)
![](./Screen/5.1-%20r2%20ip%20-4%20a.png)


- После пропинговываю ws22 с ws21 и r1 с ws11
![](./Screen/5.1-%20ws22%20ping%20with%20%20ws21.png)
![](./Screen/5%2C1-%20r1%20ping%20with%20ws11.png)


#### 5.2 Включение переадресации IP-адресов
- Чтобы включить IP-маршрутизацию на роутерах r1 и r2, нужно прописать команду: **-sysctl -w net.ipv4.ip_forward=1**. Если прописывать вручную, то переадресация не будет работать после перезагрузки системы
![](./Screen/5.2-%20r1%20ip_forward.png)
![](./Screen/5.2-%20r2%20ip_forward.png)

- Чтобы переадресация была включена на постоянной основе, нужно открыть файл **/etc/sysctl.conf** и раскомментировать строчку: **net.ipv4.ip_forward = 1**
![](./Screen/5.2-%20r1%20file%20ip_forward.png)
![](./Screen/5.2-%20r2%20file%20ip_forward2.png)


#### 5.3 Установка маршрута по-умолчанию
- Чтобы добавить маршрут по-умолчанию (шлюз) для рабочих станций. Нужно зайти в файл: **-etc/netplan/00-installer-config.yaml**, и добавить строчку: **gateway4** (шлюз), как показано в примере.
- Для ws11 это будет 10.10.0.1
- Для ws21 и ws22: 10.20.0.1

![](./Screen/5.3-%20ws11%20gateway4.png)
![](./Screen/5.3-%20ws21%20gateway4.png)
![](./Screen/5.3-%20ws22%20gateway4.png)

- Вызываю команду на рабочих машинах: **ip r**. Вижу, маршрут default добавлен.

![](./Screen/5.3-%20ws11%20ip%20r%20gateway4.png)
![](./Screen/5.3-%20ws21%20ip%20r%20gateway4.png)
![](./Screen/5.3-%20ws22%20ip%20r%20gateway4.png)

- Далее, нужно пропиновать ws11 и r2 и показать, что пинг доходит. Для этого использую команду на r2: **-sudo tcpdump -tn -i enp0s3** (enp0s3 - это название моего сетевого адаптера Интернет)
А на ws11 пишу команду:  **ping -c 5 10.100.0.12**

![](./Screen/5.3-%20r2%20ping%20tcpdumb%20enp0s3.png)
![](./Screen/5.3-%20ws11%20ping%20before%20r2.png)


#### 5.4 Добавление статических маршрутов
- Добавляю статический маршрут на r1. Нужно в таблице в сетевом интерфейсе enp0s8 прописать **routes: -to** (куда на сеть должны отправляться пакеты) **10.20.0.0/26**  **-via** (шлюз через который должен проходить трафик) **10.100.0.12**
- Далее добаляю статический маршрут на r2. Прописываю в таблице для enp0s3, чтобы достичь сети назначения **10.10.0.0/18.** **Routes: -to: 10.10.0.0/18 via: 10.100.0.11**

![](./Screen/%205.4-%20r1%20static%20route.png)
![](./Screen/5.4-%20r2%20static%20route.png)

- После прописываю: **-sudo netplan apply** на обеих роутерах, и  вывожу таблицу: **-ip r**

![](./Screen/5.4-%20r1%20ip%20r.png)
![](./Screen/5.4-%20r2%20ip%20r.png)

- Запускаю на ws11 команды: **ip r list 10.10.0.0/18** и **ip r list 0.0.0.0/0**

![](./Screen/5.4-%20ws11%20commands.png)

- Это происходит из-за принципа наиболее точного совпадения (longest prefix match). Самая конкретная из совпадающих записей таблицы - та, которая имеет самую длинную маску подсети - называется совпадением самого длинного префикса. Поскольку префикс (/18) длиннее, чем префикс (/0), что делает маршрут более конкретным.  


#### 5.5 Построение списка маршрутизаторов
- На r1 запускаю команду: **-sudo tcpdump -tnv -I enp0s8**, а на ws11 строю список маршрутизаторов на пути ws21 с помощью команды: **traceroute 10.20.0.10 **

![](./Screen/5.5-%20r1%20tcpdump.png)
![](./Screen/5.5-%20ws11%20traceroute.png)

- Traceroute основана на протоколе ICMP. Программа traceroute выполняет отправку данных указанному узлу сети, при этом отображая сведения о всех промежуточных маршрутизаторах, через которые прошли данные на пути к целевому узлу.
- Для определения промежуточных маршрутизаторов traceroute отправляет серию пакетов данных целевому узлу, при этом каждый раз увеличивая на 1 значение поля TTL («время жизни»). Это поле обычно указывает максимальное количество маршрутизаторов, которое может быть пройдено пакетом. Первый пакет отправляется с TTL, равным 1, и поэтому первый же маршрутизатор возвращает обратно сообщение ICMP, указывающее на невозможность доставки данных. Traceroute фиксирует адрес маршрутизатора, а также время между отправкой пакета и получением ответа (эти сведения выводятся на монитор компьютера). Затем traceroute повторяет отправку пакета, но уже с TTL, равным 2, что позволяет первому маршрутизатору пропустить пакет дальше.
- Процесс повторяется до тех пор, пока при определённом значении TTL пакет не достигнет целевого узла. При получении ответа от этого узла процесс трассировки считается завершённым.


#### 5.6. Использование протокола ICMP при маршрутизации
- Запускаю команду: **-sudo tcpdump -n -I enp0s8 imp**, для перехвата трафика, проходящего через enp0s8, а на ws11 пингую с несуществующим IP

![](./Screen/5.6-%20r1%20tcpdump%20icmp.png)
![](./Screen/5.6-%20ws11%20ping%2010.30.0.111.png)


## Part 6. Динамическая настройка IP с помощью DHCP
- Для r2 скачиваю **isc-dhcp-server**, после захожу в файл **/etc/dhcp/dhcpd.conf** в конфигурацию службы DHCP и добавляю адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети. 
![](./Screen/6-%20r2%20%20option%20DHCP.png)

- Далее, в файле **resolv.conf** прописываю: nameserver 8.8.8.8. После, на r2 перезагружаю службу DHCP командой: **systemctl restart isc-dhcp-server.**
![](./Screen/6-%20r2%20option%20nameserver.png)

- Перезагружаю ws21 при помощи команды: **reboot**, и прописываю **ip a**
![](./Screen/6-%20ws21%20ip%20a.png)

- Пропинговываю ws22 с ws21
![](./Screen/6-%20ws22%20ping%20with%20ws21.png)

- Узнаю MAC-адрес у ws11 с помощью команды: **-il link show**. Перехожу в файл **/etc/netplan/00-installer-config.yaml** и добавляю: macaddress и меняю dhcp4 на true.
![](./Screen/6-%20ws11%20macaddress.png)

- Теперь проделываю тоже самое, что и с r2. Для r1 скачиваю **isc-dhcp-server**, после захожу в файл **/etc/dhcp/dhcpd.conf** в конфигурацию службы DHCP и добавляю адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети, только добавляю строчку с привязной к MAC-адресу ws11 
![](./Screen/6-%20r1%20option%20DHCP%20ws11.png)
![](./Screen/6-%20r1%20%20option%20nameserver.png)

- Перезагружаю ws11 при помощи команды: **reboot**, и прописываю **ip a**
![](./Screen/6-%20ws11%20reboot%20ip%20a.png)

- После для ws21 обновляю ip-адреса с помощью команд: **-sudo dhclient -r enp0s8** (-r освободить IP-адрес) и **-sudo dhclient enp0s8**. И проверяю с помощью команды: **ip a**

- До обновления ip-адреса
![](./Screen/6-%20ws21%20ip%20a.png)
- После обновления
![](./Screen/6-%20ws21%20dhclient.png)


## Part 7. NAT
- Устанавливаю apache2 на ws22 и r1. Перехожу в файл /etc/apache2/ports.conf и изменяю строку: Listen 80 на Listen 0.0.0.0:80, делая их общедоступным
![](./Screen/7-%20ws22%20apache2.png)
![](./Screen/7-%20r2%20apache2.png)

- Запускаю веб-сервера Apache командой: -service apache2 start на ws22 и r1
![](./Screen/7-%20ws22%20start%20apache2.png)
![](./Screen/7-%20r1%20start%20apache2.png)

- На r2 создаю файл для firewall и прописываю правила: iptables -F (удаление правил в таблице filter), iptables -F -t nat (Удаление правил в таблице nat), iptables —polisy FORWARD DROP (отбрасывает все маршрутизируемые пакеты). И запускаю файл.
![](./Screen/7-%20r2%20firewall%20.png)
![](./Screen/7-%20r2%20start%20sh.png)

- Проверяю соединение ws22 и r1 (не должны пинговаться)
![](./Screen/7-%20ws22%20ping%20with%20r1.png)

- Добавляю правило в файл firewall на r2, разрешая маршрутизацию всех пакетов протокола ICMP
![](./Screen/7-%20r2%20ICMP.png)

- Проверяю соединение ws22 и r1 (теперь должны пинговаться)
![](./Screen/7-%20ws22%20ping%20with%20r1%20ICMP.png)

- Далее, нужно добавить правила для SNAT и DNAT
![](./Screen/7-%20r2%20SNAT%20and%20DNAT%20sh.png)

- После проверить соединение по TCP для SNAT: подключаюсь с ws22 к серверу Apache на r1 командой: telnet 10.100.0.11 80
![](./Screen/7-%20ws22%20telnet%20port%2080.png)

- И проверить соединение по TCP для DNAT: подключаюсь с r1 на сервер Apache на ws22 командой: telnet 10.100.0.12 8080
![](./Screen/7-%20r1%20telnet%20port%208080.png)


## Part 8. Дополнительно. Знакомство с SSH Tunnels
- На r2 также, как и в парт7 запускаю файл firewall с помощью команд: **-sudo chmod -x /e	tc/firewall.sh && sudo sh /etc/firewall.sh.**

- На ws22 захожу в файл **/etc/apache2/ports.conf** и изменяю строку с Listen 0.0.0.0:80 на **Listen localhost:80** и запускаю командой: **service apache2 start**
![](./Screen/8-%20ws22%20apache%20localhost.png)
![](./Screen/8-%20ws22%20apache%20start.png)

- Теперь нужно установить **OpenSSH server** командой: -**sudo apt install openssh-server** (установил на ws21 и ws22), иначе не смогу обратно переключиться на ws21.

- **Local TCP forwarding** — проброс локального порта на удаленный сервер. Дальше прописываю команду на ws21: **-ssh -L 7777:localhost:80 ws22server@10.20.0.20** и ввожу пароль от ws22 и подключаюсь к ws22 через ws21. (Ps. Можно вернуться обратно к ws21, используя команду: **-ssh -L 7777:localhost:80 ws21server@10.20.0.10** и ввести пароль от ws21.)
![](./Screen/8-%20ws21%20ssh(ws22)%20one.png)
![](./Screen/8-%20ws21%20ssh(ws22)%20two.png)
![](./Screen/8-%20ws21%20ssh(ws22)%20back%20ws21.png)
![](./Screen/8-%20ws21%20back%20ws21%202.png)

- **Remote TCP forwarding** — проброс удаленного порта на локальный компьютер. На ws11 пишу такую же команду (только вместо ключа -L пишу -R): **-ssh -R 7777:localhost:80 ws22server@10.20.0.20**. (Ps2. На ws11, чтобы вернуться с ws22 на ws11, нужно установить службу ssh на ws11 командой: **-sudo apt install openssh-server**. И прописать команду: **-ssh -R 7777:localhost:80 ws11server@10.10.0.2** и ввести пароль от ws11)
![](./Screen/8-%20ws11%20ssh(ws22)%20one.png)
![](./Screen/8-%20ws11%20ssh(ws22)%20two.png)
![](./Screen/8-%20ws11%20back(ws22)%20one.png)
![](./Screen/8-%20ws11%20back%20ws11%20%20two.png)

- И для проверки, сработали ли подключение в обоих предыдущих пунктах, нужно выполнить команду на ws22: telnet 127.0.0.1 80
![](./Screen/8-%20telnet%20127%20in%20ws22.png)